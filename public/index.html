<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>The Super Cool Computer</title>
    <meta name="application-name" content="Qwark" />
    <meta name="description" content="Qwark Web Computer" />
    <meta
      name="viewport"
      content="viewport-fit=cover,user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta
      name="theme-color"
      content="#378844"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#378844"
      media="(prefers-color-scheme: dark)"
    />
    <link
      id="favicon"
      rel="icon"
      href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555"
    />

    <!-- manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- PWA - apple specific -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Qwark" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link
      rel="apple-touch-icon"
      href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555"
    />

    <!-- PWA - microsoft specific -->
    <meta name="msapplication-TileColor" content="#0000FF" />
    <meta
      name="msapplication-TileImage"
      content="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555"
    />

    <!-- https:// -->
    <!-- if not running in localhost or file, assure running https -->
    <script>
      window.debug = false;

      if (window.location.protocol == "https:") {
        console.log("üîí10 Running in https");
      } else if (
        window.location.protocol !== "https:" &&
        window.location.hostname !== "localhost" &&
        window.location.protocol !== "file:"
      ) {
        window.location.protocol = "https";
        console.log("üîí10 Enforcing https");
      } else {
        console.log("üõ†Ô∏è10 Running in localhost or file, not enforcing https");
      }
    </script>

    <!-- service worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js", { scope: "/" })
          .then(function (registration) {
            console.log("+-> (1) üòç Service Worker registered", registration);

            // √âcouter les mises √† jour du service worker
            registration.addEventListener("updatefound", function () {
              let newWorker = registration.installing;
              newWorker.addEventListener("statechange", function () {
                switch (newWorker.state) {
                  case "installed":
                    if (navigator.serviceWorker.controller) {
                      console.log(
                        "+-> (2) ‚ú® Nouvelle version du Service Worker disponible"
                      );
                      // Ici, vous pourriez notifier l'utilisateur ou rafra√Æchir automatiquement la page
                    } else {
                      console.log(
                        "+-> (2) üéâ Service Worker install√© pour la premi√®re fois"
                      );
                    }
                    break;

                  case "redundant":
                    console.error(
                      "!!! (-) üÜò Le nouveau Service Worker a √©t√© rejet√©"
                    );
                    break;
                }
              });
            });
          })
          .catch(function (error) {
            console.error(
              "!!! (-) üÜò Service Worker registration failed",
              error
            );
          });
      } else {
        console.warn("!!! (-) üÜò Service Worker not supported in this browser");
      }
    </script>

    <style>
      body {
        font-family: monospace;
        background-color: black;
        color: #20ff20;
        margin: 0%;
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      div {
        margin: 0px;
        padding: 0px;
      }

      /* Set editor dimensions */
      #editor {
        height: 100%;
        width: 100%;
      }

      /* Stretch editor to fit inside its containing div */
      .cm-editor {
        height: 100%;
        width: 100%;
      }

      #ui {
        position: fixed;
        top: 0px;
        left: 0px;
        font-family: monospace;
        width: 100vw;
        height: 100vh;
        display: none;
        margin: 0px;
        padding: 0px;
        background-color: black;
        color: #20ff20;
        overflow: auto; /* Permet le d√©filement si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
      }

      #ui::-webkit-scrollbar {
        display: none;
      }

      #ui-toolbox {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: auto; /* Permet le d√©filement si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
      }
      #ui-toolbox::-webkit-scrollbar {
        display: none;
      }

      center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
      red {
        color: red;
      }
      white {
        color: white;
      }
      blue {
        color: blue;
      }
      green {
        color: green;
      }
      yellow {
        color: yellow;
      }
      orange {
        color: orange;
      }
      purple {
        color: purple;
      }

      button {
        display: block;
        margin: 0px;
        margin-left: auto;
        margin-right: auto;
        border: 2px solid #20ff20;
        border-radius: 10px;
        background-color: #001000;
        color: #20ff20;
      }
      #appName,
      #appImage,
      #appDescription,
      #loadApp,
      #appList {
        display: block;
        margin: 5px auto;
        padding: 5px;
        border: 2px solid #20ff20;
        border-radius: 10px;
        background-color: #001000;
        color: #20ff20;
      }

      #toolbar {
        display: flex;
        justify-content: center; /* Centre les boutons horizontalement */
        align-items: center; /* Centre les boutons verticalement */
        overflow-x: auto; /* Permet le d√©filement horizontal si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
      }

      #toolbar::-webkit-scrollbar {
        display: none;
      }
      #toolbar button {
        margin: 5px;
        padding: 8px;
      }
      .cm-editor .cm-content {
        font-size: 10px; /* or whatever size you prefer */
      }
    </style>
  </head>

  <body>
    <div id="settings">
      <select id="appList"></select>
    </div>

    <div id="editor"></div>

    <div id="ui"></div>

    <button
      id="actionButton"
      style="position: fixed; bottom: 10px; left: 10px; z-index: 1000"
    >
      Run
    </button>

    <button
      id="saveButton"
      onclick="Save()"
      style="position: fixed; bottom: 10px; right: 10px; z-index: 1000"
    >
      Save
    </button>

    <div id="console-messages"></div>

    <!-- CodeMirror 6 -->
    <script src="cm6.bundle.min.js"></script>

    <script>
      //document.getElementById('backButton').addEventListener('click', function() {document.getElementById('ui').style.display = 'none' })

      // √âcoutez les messages provenant du service worker
      document.addEventListener("DOMContentLoaded", () => {
        navigator.serviceWorker.ready.then((registration) => {
          // RECEPTION des messages du Service Worker :
          navigator.serviceWorker.addEventListener("message", (event) => {
            const message = event.data;
            if (message.type === "console-log") {
              if (window.debug) displayConsoleMessage(message.text);
            }
          });
          // Envoie un message "ready" au service worker :
          registration.active.postMessage({ type: "ready" });
        });
      });

      let currentApp = { name: "", description: "", image: "", code: "" };
      let isAppAlreadyLoadedFromLocalStorage = false;

      /////////////////////////////
      //
      // editor (code mirror 6)
      //
      // Codemirror 6

      const view = cm6.createEditorView(
        undefined,
        document.getElementById("editor")
      );

      let options = {
        oneDark: true,
      };

      const initialState = cm6.createEditorState(
        `
//////////////////////////
// Ma Premi√®re App V12üíñ //
//////////////////////////

import { clear, print, addDiv } from "https://qwark.glitch.me/toolbox.js";

clear()

print('<h1>üòÅ hello ! </h1><br>')

let i=1

setInterval( ()=> {
  print(i,',')
  i++;
}, 1000)

print('üòé')`,
        options
      );
      view.setState(initialState);

      // Affichage de message dans le div console
      function displayConsoleMessage(text) {
        const consoleMessagesDiv = document.getElementById("console-messages");
        const messageElement = document.createElement("div");
        // Utilisez innerHTML au lieu de textContent
        messageElement.innerHTML = text.replace(/\n/g, "<br>");
        consoleMessagesDiv.appendChild(messageElement);
      }

      function LoadAppList() {
        //return
        fetch("/listApps")
          .then((response) => response.json())
          .then((apps) => {
            const appList = document.getElementById("appList");
            appList.innerHTML = ""; // Nettoyer la liste avant de la remplir
            apps.forEach((app) => {
              const option = document.createElement("option");
              option.value = app;
              option.textContent = app;
              appList.appendChild(option);
            });
            appList.addEventListener("change", function () {
              LoadApp();
              localStorage.setItem("lastEditedApp", appList.value); // Sauvegarder le nom de l'application s√©lectionn√©e
            });
            // S√©lectionner l'application qui √©tait en cours d'√©dition lors du rechargement de la page
            const lastEditedApp = localStorage.getItem("lastEditedApp");
            if (lastEditedApp) {
              appList.value = lastEditedApp;
              LoadApp(); // Charger l'application s√©lectionn√©e
            }
          })
          .catch((error) =>
            alert("Erreur lors du chargement de la liste: " + error)
          );
      }

      function LoadApp() {
        const selectedApp = document.getElementById("appList").value;
        fetch(`/loadApp?name=${encodeURIComponent(selectedApp)}`)
          .then((response) => response.json())
          .then((appData) => {
            //document.getElementById('code').value = appData.code;

            //si le chargement de la page provient d'un retour de run, alors on charge le code dans le localStorage
            // Cr√©er un objet URLSearchParams √† partir de la cha√Æne de requ√™te actuelle
            const urlParams = new URLSearchParams(window.location.search);
            // R√©cup√©rer la valeur du param√®tre 'param'
            const monParam = urlParams.get("param");
            console.log("##### param = ", monParam);
            if (monParam && !isAppAlreadyLoadedFromLocalStorage) {
              let code = localStorage.getItem("storedBeforeRun");
              view.dispatch({
                changes: {
                  from: 0,
                  to: view.state.doc.length,
                  insert: code,
                },
              });
              isAppAlreadyLoadedFromLocalStorage = true;
            } else {
              view.dispatch({
                changes: {
                  from: 0,
                  to: view.state.doc.length,
                  insert: appData.code,
                },
              });
            }
            currentApp.name = appData.name;
            // Mettre √† jour les champs de param√®tres si n√©cessaire
            /*document.getElementById("appName").value = appData.name;
            document.getElementById("appImage").value = appData.image;
            document.getElementById("appDescription").value =
              appData.description;*/
          })
          .catch((error) =>
            alert("Erreur lors du chargement de l'app: " + error)
          );
      }

      // Appelez LoadAppList au chargement de la page ou √† un moment appropri√©
      window.onload = LoadAppList;

      // a try to exec the code without iframe.... in order to be able the service workers to serve the code to exec
      //   -> RESET
      function resetUI() {
        let ui = document.getElementById("ui");
        removeChildren(ui); // Supprime les enfants actuels de 'ui'
        ui.style.overflowY = "";
        ui.style.height = "";

        // Cr√©er une nouvelle div
        let uiToolbox = document.createElement("div");
        uiToolbox.id = "ui-toolbox"; // Assigner l'ID 'ui-toolbox'

        // Ajouter la nouvelle div √† 'ui'
        ui.appendChild(uiToolbox);
      }

      //   -> WARNING : THIS WILL RESET ALLLL TIMERS !!!!!!
      function resetTimers() {
        let maxId = setTimeout(function () {}, 0);

        for (var i = 0; i < maxId; i += 1) {
          clearTimeout(i);
        }
      }
      //   -> REMOVE
      function removeChildren(node) {
        while (node.hasChildNodes()) {
          //node.removeEventListener()
          node.removeChild(node.lastChild);
        }
      }
      //    -> EVALUATE
      const evaluateCode = (code) => {
        //console.clear(); ///////////////////////////////// NEW //
        resetUI();
        resetTimers();
        //localStorage.setItem("mysupercomputer-code", code);
        const scriptId = "dynamic-module-script";

        // Supprimer l'ancien script s'il existe
        const oldScript = document.getElementById(scriptId);
        if (oldScript) {
          document.body.removeChild(oldScript);
        }

        // Cr√©er un nouveau script
        const script = document.createElement("script");
        script.type = "module";
        script.id = scriptId;
        script.textContent = code;

        // Ajouter le nouveau script au body
        document.body.appendChild(script);
      };

      // Variable pour suivre le mode actuel
      let isEditMode = true;

      document
        .getElementById("actionButton")
        .addEventListener("click", function () {
          if (isEditMode) {
            // En mode √©dition, ex√©cuter le code
            Exec("ui", "code");
            this.textContent = "Retour";
            isEditMode = false;
          } else {
            // En mode ex√©cution, recharger la page avec un contr√¥le sur le param√®tre 'param'

            // Cr√©ez un objet URL √† partir de l'URL actuelle
            let url = new URL(window.location.href);
            let params = new URLSearchParams(url.search);

            // V√©rifiez si le param√®tre 'param' est d√©j√† pr√©sent
            if (!params.has("param")) {
              params.set("param", "1"); // Ajoutez 'param=1' si ce n'est pas d√©j√† le cas
              url.search = params.toString(); // Mettez √† jour la cha√Æne de requ√™te
            }

            // Rechargez la page avec la nouvelle URL (si modifi√©e) ou l'URL actuelle
            window.location.href = url.toString();

            this.textContent = "Run";
            isEditMode = true;
          }
        });

      function Exec(uiId, codeId) {
        document.getElementById("ui").style.display = "block";
        let code = view.state.doc.toString();
        localStorage.setItem("storedBeforeRun", code);
        evaluateCode(code);
        // Changements pour basculer en mode ex√©cution
        isEditMode = false;
        document.getElementById("actionButton").textContent = "Retour";
      }
      /*
      function Save() {
          let code = document.getElementById('code').value;
          let blob = new Blob([code], { type: "text/plain" });
          let anchor = document.createElement("a");
          anchor.download = "myCode.txt";
          anchor.href = window.URL.createObjectURL(blob);
          anchor.click();
      }
      function Load() {
          let input = document.createElement('input');
          input.type = 'file';
          input.onchange = e => {
              let file = e.target.files[0];
              let reader = new FileReader();
              reader.readAsText(file, 'UTF-8');
              reader.onload = readerEvent => {
                  let content = readerEvent.target.result;
                  document.getElementById('code').value = content; 
              }
          }
          input.click();
      }*/

      function Save() {
        const settings = {
          name: currentApp.name,
          image: currentApp.image,
          description: currentApp.description,
          code: view.state.doc.toString(),
        };
        fetch("/save", {
          method: "POST",
          body: JSON.stringify(settings),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.text())
          .then((data) => {
            alert(data);
            LoadAppList();
            localStorage.setItem("lastEditedApp", currentApp.name); // Sauvegarder le nom de l'application sauvegard√©e
          })
          .catch((error) => alert("Erreur lors de la sauvegarde: " + error));
      }

      function Load() {
        fetch("/load")
          .then((response) => response.text())
          .then((data) => (document.getElementById("code").value = data))
          .catch((error) => alert("Erreur lors du chargement: " + error));
      }
    </script>
  </body>
</html>
