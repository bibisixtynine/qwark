<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>The Super Cool Computer</title>
    <meta name="application-name" content="Qwark" />
    <meta name="description" content="Qwark Web Computer" />
    <meta name="viewport" content="viewport-fit=cover,user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="theme-color" content="#378844" media="(prefers-color-scheme: light)"/>
    <meta name="theme-color" content="#378844" media="(prefers-color-scheme: dark)"/>
    <link id="favicon" rel="icon" href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555"/>

    <!-- PWA - manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- PWA - apple specific -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Qwark" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <link rel="apple-touch-icon" href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555"/>

    <!-- PWA - microsoft specific -->
    <meta name="msapplication-TileColor" content="#0000FF" />
    <meta name="msapplication-TileImage" content="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555"/>

    <!-- https:// -->
    <!-- if not running in localhost or file, assure running https -->
    <script>
      window.debug = false;

      if (window.location.protocol == "https:") {
        console.log("üîí10 Running in https");
      } else if (
        window.location.protocol !== "https:" &&
        window.location.hostname !== "localhost" &&
        window.location.protocol !== "file:"
      ) {
        window.location.protocol = "https";
        console.log("üîí10 Enforcing https");
      } else {
        console.log("üõ†Ô∏è10 Running in localhost or file, not enforcing https");
      }
    </script>
    
    <!-- phaser 3.7 lib -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <!-- PWA - service worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/sw.js", { scope: "/" })
          .then(function (registration) {
            console.log("+-> (1) üòç Service Worker registered", registration);

            // √âcouter les mises √† jour du service worker
            registration.addEventListener("updatefound", function () {
              let newWorker = registration.installing;
              newWorker.addEventListener("statechange", function () {
                switch (newWorker.state) {
                  case "installed":
                    if (navigator.serviceWorker.controller) {
                      console.log(
                        "+-> (2) ‚ú® Nouvelle version du Service Worker disponible"
                      );
                      // Ici, vous pourriez notifier l'utilisateur ou rafra√Æchir automatiquement la page
                    } else {
                      console.log(
                        "+-> (2) üéâ Service Worker install√© pour la premi√®re fois"
                      );
                    }
                    break;

                  case "redundant":
                    console.error(
                      "!!! (-) üÜò Le nouveau Service Worker a √©t√© rejet√©"
                    );
                    break;
                }
              });
            });
          })
          .catch(function (error) {
            console.error(
              "!!! (-) üÜò Service Worker registration failed",
              error
            );
          });
      } else {
        console.warn("!!! (-) üÜò Service Worker not supported in this browser");
      }
    </script>

    
    <!-- ----------- -->
    <!-- style sheet -->
    <!-- ----------- -->
    <style>
      body {
        font-family: monospace;
        background-color: black;
        color: #20ff20;
        margin: 0%;
        padding: env(safe-area-inset-top) env(safe-area-inset-right)
          env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      div {
        margin: 0px;
        padding: 0px;
      }

      /* Set editor dimensions */
      #editor {
        height: 100%;
        width: 100%;
      }

      /* Stretch editor to fit inside its containing div */
      .cm-editor {
        height: 100%;
        width: 100%;
      }     
      .cm-editor .cm-content {
        font-size: 12px; /* or whatever size you prefer */
        background-color: #141414; /* Couleur de fond sombre */
      }
      .cm-lineNumbers {
        background-color: #141414;
      }

      #ui {
        position: fixed;
        top: 0px;
        left: 0px;
        font-family: monospace;
        width: 100vw;
        height: 100vh;
        display: none;
        margin: 0px;
        padding: 0px;
        background-color: black;
        color: #20ff20;
        overflow: hidden; /* NE Permet PAS le d√©filement si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
       
        -webkit-text-size-adjust: 100%;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-user-select: none;
        -moz-user-select: -moz-none;
        -ms-user-select: none;
        user-select: none;
        touch-action: none;
      }
      #ui::-webkit-scrollbar {
        display: none;
      }

      center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
      red {
        color: red;
      }
      white {
        color: white;
      }
      blue {
        color: blue;
      }
      green {
        color: green;
      }
      yellow {
        color: yellow;
      }
      orange {
        color: orange;
      }
      purple {
        color: purple;
      }

      button {
        display: block;
        margin: 0px;

        border: 2px solid #20ff20;
        border-radius: 10px;
        background-color: #001000;
        color: #20ff20;
        
        padding: 5px;
      }

      #appList {
        margin: 0px;
        
        border: 2px solid #20ff20;
        border-radius: 10px;
        background-color: #001000;
        color: #20ff20;
        
        position: fixed;
        top: env(safe-area-inset-top);
        
        z-index: 1000;
        
        left: 50%; /* Centre horizontalement */
        transform: translateX(-50%);
        padding: 5px;
      }

      #toolbar {
        display: flex;
        justify-content: center; /* Centre les boutons horizontalement */
        align-items: center; /* Centre les boutons verticalement */
        overflow-x: auto; /* Permet le d√©filement horizontal si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
      }

      #toolbar::-webkit-scrollbar {
        display: none;
      }
      
      #toolbar button {
        margin: 5px;
        padding: 8px;
      }
      
      .hidden {
        display: none;
      }

      .visible {
        display: block;
      }

    </style>
  </head>

  <body>
   
    <!-- -- --> 
    <!-- UI -->    
    <!-- -- -->
    <select id="appList"></select>
    <div id="editor"></div>
    <div id="ui"><div id="gameContainer" style="width:100%; height:100%"></div></div>
    <button id="actionButton" style="position: fixed; bottom: env(safe-area-inset-bottom); left: 10px; z-index: 1000">Run</button>
    <button id="saveButton" onclick="Save()" style="position: fixed; bottom: env(safe-area-inset-bottom); right: 10px; z-index: 1000">Save</button>
    <button id="increaseFontSize" style="position: fixed; top: env(safe-area-inset-top); right: 10px; z-index: 1000">zoom+</button>
    <button id="decreaseFontSize" style="position: fixed; top: env(safe-area-inset-top); left: 10px; z-index: 1000">zoom-</button>
    <button id="usernameButton" onclick="enterUsername()" style="position: fixed; bottom: env(safe-area-inset-bottom); left: 50%; transform: translateX(-50%); z-index: 1000">Enter Username</button>

    <div id="console-messages"></div>

    
    <!-- ---------- --> 
    <!-- librairies -->    
    <!-- ---------- -->
    
    <!-- Code Mirror 6 -->
    <script src="cm6.bundle.min.js"></script>

    
    <!-- ----------- --> 
    <!-- main script -->    
    <!-- ----------- --> 
    <script>
      
      /////////////////////////////////////////////////////////////
      //
      // √âcoutez les messages provenant du service worker
      //
      document.addEventListener("DOMContentLoaded", () => {
        navigator.serviceWorker.ready.then((registration) => {
          // RECEPTION des messages du Service Worker :
          navigator.serviceWorker.addEventListener("message", (event) => {
            const message = event.data;
            if (message.type === "console-log") {
              if (window.debug) displayConsoleMessage(message.text);
            }
          });
          // Envoie un message "ready" au service worker :
          registration.active.postMessage({ type: "ready" });
        });
      });

      let currentApp = { name: "", description: "", image: "", code: "" };
      let isAppAlreadyLoadedFromLocalStorage = false;

      
      /////////////////////////////////////////////////////////////
      //
      // editor (cm6)
      //
      const view = cm6.createEditorView(
        undefined,
        document.getElementById("editor")
      );

      let options = {
        oneDark: true,
      };

      const initialState = cm6.createEditorState(
        `
////////////////////
// LOADING  QWARK //
////////////////////

`,
        options
      );
      
      view.setState(initialState);
      
      document
        .getElementById("increaseFontSize")
        .addEventListener("click", function () {
          changeFontSize(1);
        });

      document
        .getElementById("decreaseFontSize")
        .addEventListener("click", function () {
          changeFontSize(-1);
        });

      function changeFontSize(delta) {
        const editorElement = document.querySelector(".cm-editor .cm-content");
        const currentSize = parseInt(
          window.getComputedStyle(editorElement).fontSize
        );
        const newSize = currentSize + delta;
        editorElement.style.fontSize = `${newSize}px`;
        
        // Enregistrer la nouvelle taille dans localStorage
        localStorage.setItem("editorFontSize", newSize);
      }
      
      document.addEventListener("DOMContentLoaded", () => {
        // Restituer la taille de la police de l'√©diteur
        const savedFontSize = localStorage.getItem("editorFontSize");
        if (savedFontSize) {
            const editorElement = document.querySelector(".cm-editor .cm-content");
            editorElement.style.fontSize = `${savedFontSize}px`;
        }
      });

      // Affichage de message dans le div console
      function displayConsoleMessage(text) {
        const consoleMessagesDiv = document.getElementById("console-messages");
        const messageElement = document.createElement("div");
        // Utilisez innerHTML au lieu de textContent
        messageElement.innerHTML = text.replace(/\n/g, "<br>");
        consoleMessagesDiv.appendChild(messageElement);
      }

      function LoadAppList() {
        //return
        fetch("/listApps")
          .then((response) => response.json())
          .then((apps) => {
            const appList = document.getElementById("appList");
            appList.innerHTML = ""; // Nettoyer la liste avant de la remplir
            apps.forEach((app) => {
              const option = document.createElement("option");
              option.value = app;
              option.textContent = app;
              appList.appendChild(option);
            });
            appList.addEventListener("change", function () {
              LoadApp();
              localStorage.setItem("lastEditedApp", appList.value); // Sauvegarder le nom de l'application s√©lectionn√©e
            });
            // S√©lectionner l'application qui √©tait en cours d'√©dition lors du rechargement de la page
            const lastEditedApp = localStorage.getItem("lastEditedApp");
            if (lastEditedApp) {
              appList.value = lastEditedApp;
              LoadApp(); // Charger l'application s√©lectionn√©e
            } else {
              LoadApp(); // Charger l'application par d√©faut
            }
          })
          .catch((error) =>
            alert("Erreur lors du chargement de la liste: " + error)
          );
      }

      function LoadApp() {
        const selectedApp = document.getElementById("appList").value;
        fetch(`/loadApp?name=${encodeURIComponent(selectedApp)}`)
          .then((response) => response.json())
          .then((appData) => {
            //si le chargement de la page provient d'un retour de run, alors on charge le code dans le localStorage
            // Cr√©er un objet URLSearchParams √† partir de la cha√Æne de requ√™te actuelle
            const urlParams = new URLSearchParams(window.location.search);
            // R√©cup√©rer la valeur du param√®tre 'param'
            const monParam = urlParams.get("param");
            console.log("##### param = ", monParam);
            if (monParam && !isAppAlreadyLoadedFromLocalStorage) {
              let code = localStorage.getItem("storedBeforeRun");
              view.dispatch({
                changes: {
                  from: 0,
                  to: view.state.doc.length,
                  insert: code,
                },
              });
              // Restaurer la position de d√©filement
              const savedScrollPosition = localStorage.getItem('scrollPosition');
              if (savedScrollPosition) {
                  window.scrollTo(0, parseInt(savedScrollPosition));
              }
              isAppAlreadyLoadedFromLocalStorage = true;
            } else {
              view.dispatch({
                changes: {
                  from: 0,
                  to: view.state.doc.length,
                  insert: appData.code,
                },
              });
            }
            currentApp.name = appData.name;
          })
          .catch((error) =>
            alert("Erreur lors du chargement de l'app: " + error)
          );
      }

      // Appelez LoadAppList au chargement de la page ou √† un moment appropri√©
      window.onload = function() {
        // Reste du code onload
        LoadAppList();

        // Si un nom d'utilisateur est d√©j√† enregistr√©, affichez-le
        if (username) {
          document.getElementById("usernameButton").textContent = `Username: ${username}`;
        }
      };

      // Variable pour suivre le mode actuel
      let isEditMode = true;
      setEditMode(true);
      
      document
        .getElementById("actionButton")
        .addEventListener("click", function () {
          if (isEditMode) {
            // En mode √©dition, ex√©cuter le code
            Exec("ui", "code");
            this.textContent = "Back";
            isEditMode = false;
          } else {
            // En mode ex√©cution, recharger la page avec un contr√¥le sur le param√®tre 'param'

            // Cr√©ez un objet URL √† partir de l'URL actuelle
            let url = new URL(window.location.href);
            let params = new URLSearchParams(url.search);

            // V√©rifiez si le param√®tre 'param' est d√©j√† pr√©sent
            if (!params.has("param")) {
              params.set("param", "1"); // Ajoutez 'param=1' si ce n'est pas d√©j√† le cas
              url.search = params.toString(); // Mettez √† jour la cha√Æne de requ√™te
            }

            // Rechargez la page avec la nouvelle URL (si modifi√©e) ou l'URL actuelle
            window.location.href = url.toString();

            this.textContent = "Run";
            isEditMode = true;
            setEditMode(true);
          }
        });

      function Exec(uiId, codeId) {
        document.getElementById("ui").style.display = "block";
        let code = view.state.doc.toString();
        localStorage.setItem("storedBeforeRun", code);

        // Enregistrer la position de d√©filement
        const scrollPosition = window.scrollY;
        localStorage.setItem('scrollPosition', scrollPosition);

        // Cacher les boutons en mode ex√©cution
        setEditMode(false);
        
        // run !
        const script = document.createElement("script");
        script.type = "module";
        script.id = "dynamic-module-script";
        script.textContent = code;

        // Ajouter le nouveau script au body
        document.body.appendChild(script);;
      }

      function setEditMode(isEditMode) {
        const elementsToHide = [document.getElementById("saveButton"),
                                document.getElementById("increaseFontSize"),
                                document.getElementById("decreaseFontSize"),
                                document.getElementById("appList"),
                                document.getElementById("usernameButton"),
                               ];
        if (isEditMode) {
          elementsToHide.forEach(el => el.classList.remove("hidden"));
          document.getElementById("actionButton").textContent = "Run";
        } else {
          elementsToHide.forEach(el => el.classList.add("hidden"));
          document.getElementById("actionButton").textContent = "Back";
        }
      }


      let username = localStorage.getItem("username") || "";

      function enterUsername() {
        username = prompt("Please enter your username:", username) || username;
        if (username) {
          localStorage.setItem("username", username);
          document.getElementById("usernameButton").textContent = `Username: ${username}`;
        }
      }
      
      function Save() {
        console.log("save ",currentApp.name)
        const settings = {
          name: currentApp.name,
          image: currentApp.image,
          description: currentApp.description,
          code: view.state.doc.toString(),
          user: username
        };
        fetch("/save", {
          method: "POST",
          body: JSON.stringify(settings),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.text())
          .then((data) => {
            alert(data);
            LoadAppList();
            localStorage.setItem("lastEditedApp", currentApp.name); // Sauvegarder le nom de l'application sauvegard√©e
          })
          .catch((error) => alert("Erreur lors de la sauvegarde: " + error));
      }

    </script>
  </body>
</html>
