<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8" />

    <title>The Super Cool Computer</title>
    <meta name="application-name" content="Qwark" />
    <meta name="description" content="Qwark Web Computer" />
    <meta name="viewport" content="viewport-fit=cover,user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="theme-color" content="#378844" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#378844" media="(prefers-color-scheme: dark)">
    <link id="favicon" rel="icon" href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555" />
    
    <!-- manifest -->
    <link rel="manifest" href="manifest.json"/>
    
    <!-- PWA - apple specific -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Qwark" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555" />
    
    <!-- PWA - microsoft specific -->
    <meta name="msapplication-TileColor" content="#0000FF" />
    <meta name="msapplication-TileImage" content="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555" />


  
    <!-- https:// -->
    <!-- if not running in localhost or file, assure running https -->
    <script>
      if (window.location.protocol == "https:") {
        console.log("üîí10 Running in https");
      } else if (
        window.location.protocol !== "https:" &&
        window.location.hostname !== "localhost" &&
        window.location.protocol !== "file:"
      ) {
        window.location.protocol = "https";
        console.log("üîí10 Enforcing https");
      } else {
        console.log("üõ†Ô∏è10 Running in localhost or file, not enforcing https");
      }
    </script>
       
    <!-- service worker -->
    <script>
      //if (location.protocol == "http:") location.protocol = "https:";
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("sw.js")
          .then((reg) =>
            console.log("+-> (1) üòç10 Service Worker registered", reg)
          )
          .catch((err) =>
            console.error("!!! (-) üÜò10 Service Worker **not** registered", err)
          );
      } else {
        console.warn("!!! (-) üÜò10 Service Worker not supported in this browser");
      }
    </script>
    
    <style>
      body {
        font-family: monospace;
        background-color: black;
        color: #20FF20;
        margin: 0%;
        padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      }
      div {
        margin: 0px;
        padding: 0px;
      }
      textarea {
        font-family: monospace;
        display: block;
        width:90%;
        height:30vh;
        margin: 5px;
        margin-left: auto;
        margin-right: auto;
        padding:10px;
        border: 2px solid #20FF20;
        border-radius: 20px;
        background-color: #001000;
        color: #20FF20;
        overflow: auto; /* Permet le d√©filement si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */

        /* Pour les navigateurs bas√©s sur WebKit comme Chrome, Safari */
      }
      textarea::-webkit-scrollbar {
          display: none;
      }
      #ui {
        position: relative;
        font-family: monospace;
        width:90%;
        height:30vh;
        margin: 5px;
        margin-left: auto;
        margin-right: auto;
        padding:10px;
        border: 2px solid #20FF20;
        border-radius: 20px;
        background-color: #001000;
        color: #20FF20;
        overflow: auto; /* Permet le d√©filement si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
      }
      #ui::-webkit-scrollbar {
        display: none;
      }
      button {
        display:block;
        margin: 0px;
        margin-left: auto;
        margin-right: auto;
        border: 2px solid #20FF20;
        border-radius: 10px;
        background-color: #001000;
        color: #20FF20;
      }
      #appName, #appImage, #appDescription, #loadApp, #appList {
        display:block;
        margin: 5px auto;
        padding: 5px;
        border: 2px solid #20FF20;
        border-radius: 10px;
        background-color: #001000;
        color: #20FF20;
      }
      
      #toolbar {
        display: flex;
        justify-content: center; /* Centre les boutons horizontalement */
        align-items: center; /* Centre les boutons verticalement */
        overflow-x: auto; /* Permet le d√©filement horizontal si n√©cessaire */
        scrollbar-width: none; /* Pour les navigateurs bas√©s sur Firefox */
        -ms-overflow-style: none; /* Pour Internet Explorer et Edge */
      }

      #toolbar::-webkit-scrollbar {
        display: none;
      }
      #toolbar button {
        margin: 5px;
        padding: 8px;
      }
    </style>
    
  </head>

  <body>
    <br>
    <textarea  spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" id="code">
//////////////////////////
// Ma Premi√®re App V10üíñ //
//////////////////////////

import {clear, print} from './toolbox.js'
 
clear()

print('<h1>üòÅ hello ! </h1><br>')

let i=1

setInterval( ()=> {
  print(i,',')
  i++;
}, 1000)

print('üòé')
    </textarea>
    
    <div id="toolbar">    
      <button onclick="Exec('ui','code')">run</button>
      <button onclick="LoadApp()">load</button>
      <button onclick="Save()">save</button>
      <button onclick="Publish()">preview</button>
    </div>  
      
    <div id="ui">
      press [run] to see your code live ! 
    </div>
    
    <div id="settings">
      <input type="text" id="appName" placeholder="Nom de l'App" />
      <input type="text" id="appImage" placeholder="Lien Image" />
      <input type="text" id="appDescription" placeholder="Description de l'App"/>
      <select id="appList"></select>
    </div>
    
   
    <script>
      function LoadAppList() {
        //return
        fetch('/listApps')
          .then(response => response.json())
          .then(apps => {
            const appList = document.getElementById('appList');
            appList.innerHTML = ''; // Nettoyer la liste avant de la remplir
            apps.forEach(app => {
              const option = document.createElement('option');
              option.value = app;
              option.textContent = app;
              appList.appendChild(option);
            });
          })
          .catch(error => alert('Erreur lors du chargement de la liste: ' + error));
      }

      function LoadApp() {
        const selectedApp = document.getElementById('appList').value;
        fetch(`/loadApp?name=${encodeURIComponent(selectedApp)}`)
          .then(response => response.json())
          .then(appData => {
            document.getElementById('code').value = appData.code;
            // Mettre √† jour les champs de param√®tres si n√©cessaire
            document.getElementById('appName').value = appData.name;
            document.getElementById('appImage').value = appData.image;
            document.getElementById('appDescription').value = appData.description;
          })
          .catch(error => alert("Erreur lors du chargement de l'app: " + error));
      }

      // Appelez LoadAppList au chargement de la page ou √† un moment appropri√©
      window.onload = LoadAppList;
      
      // a try to exec the code without iframe.... in order to be able the service workers to serve the code to exec
      //   -> RESET
      function resetUI() {
        let ui = document.getElementById('ui');
        removeChildren(ui)
        ui.style.overflowY = '';
        ui.style.height = '';
      }
      //   -> WARNING : THIS WILL RESET ALLLL TIMERS !!!!!!
      function resetTimers() {
        let maxId = setTimeout(function () {}, 0);

        for (var i = 0; i < maxId; i += 1) {
          clearTimeout(i);
        }
      }
      //   -> REMOVE
      function removeChildren(node) {
        while (node.hasChildNodes()) {
          //node.removeEventListener()
          node.removeChild(node.lastChild)
        }
      }
      //    -> EVALUATE
      const evaluateCode = (code) => {
        //console.clear(); ///////////////////////////////// NEW //
        resetUI();
        resetTimers();
        //localStorage.setItem("mysupercomputer-code", code);
        const scriptId = 'dynamic-module-script';

        // Supprimer l'ancien script s'il existe
        const oldScript = document.getElementById(scriptId);
        if (oldScript) {
          document.body.removeChild(oldScript);
        }

        // Cr√©er un nouveau script
        const script = document.createElement('script');
        script.type = 'module';
        script.id = scriptId;
        script.textContent = code;

        // Ajouter le nouveau script au body
        document.body.appendChild(script);
      };
      
      
      function Exec(uiId,codeId) {
        let code = document.getElementById(codeId).value;
        evaluateCode(code)
        /*
        let ui = document.getElementById(uiId)
        const iframe = document.createElement('iframe')
        
        iframe.width = '100%'
        iframe.height = '100%'
        iframe.srcdoc = `<script>console.log("Origine de l\'iframe:", location.origin);</s` + `cript><script id="code" type="module">` + code + '</' + 'script>'
        iframe.style.border = 'none'
        iframe.style.padding = '0px'
        iframe.style.margin = '0px'
        ui.innerHTML = ''
        ui.appendChild(iframe)*/
      }
      /*
      function Save() {
          let code = document.getElementById('code').value;
          let blob = new Blob([code], { type: "text/plain" });
          let anchor = document.createElement("a");
          anchor.download = "myCode.txt";
          anchor.href = window.URL.createObjectURL(blob);
          anchor.click();
      }
      function Load() {
          let input = document.createElement('input');
          input.type = 'file';
          input.onchange = e => {
              let file = e.target.files[0];
              let reader = new FileReader();
              reader.readAsText(file, 'UTF-8');
              reader.onload = readerEvent => {
                  let content = readerEvent.target.result;
                  document.getElementById('code').value = content; 
              }
          }
          input.click();
      }*/
      
      function Save() {
        const settings = {
          name: document.getElementById('appName').value,
          image: document.getElementById('appImage').value,
          description: document.getElementById('appDescription').value,
          code: document.getElementById('code').value
        };
        fetch('/save', {
          method: 'POST',
          body: JSON.stringify(settings),
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.text())
        .then(data => {alert(data); LoadAppList()})
        .catch(error => alert('Erreur lors de la sauvegarde: ' + error));
      }
      

      function Load() {
        fetch('/load')
        .then(response => response.text())
        .then(data => document.getElementById('code').value = data)
        .catch(error => alert('Erreur lors du chargement: ' + error));
      }
      
      function Publish() {
        console.log('publish')
        let code = document.getElementById('code').value;
        let newWindow = window.open('', '_blank'); // Ouvre un nouvel onglet
        newWindow.document.write(`
        <html>
          <head>
            <title>Qwark10 Preview</title>
            <meta charset="utf-8" />
            <meta name="viewport" content="viewport-fit=cover,user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1" />
            <meta name="apple-mobile-web-app-capable" content="yes" />
            <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
            <meta name="theme-color" content="#f2b200" />
            <link rel="apple-touch-icon" href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555" />
            <link id="favicon" rel="icon" href="https://cdn.glitch.global/e73a15d2-2f8a-477d-80bc-a6e8167fe97a/icon-computer-512.png?v=1700841061555" />
            <style>
              body {
                font-family: monospace;
                background-color: black;
                color: #20FF20;
                margin: 0%;
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
              }
            </style>
          </head>
          <body>
            <script type="module">` + code + `</` + `script>
          </body>
        </html>
        `);
        newWindow.document.close(); 
      }

    </script>
  </body>

</html>
